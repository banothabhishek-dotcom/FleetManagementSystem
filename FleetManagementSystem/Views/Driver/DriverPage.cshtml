@model List<FleetManagementSystem.Models.Trip_Scheduling>

@{
    Layout = "~/Views/Shared/_DriverLayout.cshtml";
    ViewData["Title"] = "Home";
}

<link rel="stylesheet" href="/css/DriverPage.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

@if (TempData["RideCompleted"] != null && (bool)TempData["RideCompleted"])
{
    <div class="alert alert1 alert-success alert-dismissible fade show " role="alert">
        <strong>✅ Payment successfull Ride Completed !</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div style="margin-top:100px">
    
    <div class="container mt-5">
        <div class="card shadow-lg rounded p-4 mb-4 bg-light">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <h1 class="fw-bold text-primary">Welcome @Context.Session.GetString("DriverName")</h1>
                    <p class="lead text-muted">Have a great day! Start your rides.</p>
                </div>
                <div class="col-md-6 text-center">
                    <img src="/assets/driver.webp" alt="Driver Logo" class="img-fluid rounded" style="max-height: 180px;">
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <div class="card shadow-lg rounded p-4">
            <h4 class="text-center mb-4 text-primary">Assigned Trips</h4>

            @if (Model != null && Model.Any())
            {
                foreach (var trip in Model)
                {
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-success">Pickup Details</h5>
                            <div class="row mb-2">
                                <div class="col-md-6"><strong>Name:</strong> @(trip.Firstname + " " + trip.Lastname)</div>
                                <div class="col-md-6"><strong>Phone:</strong> @trip.PhoneNumber</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6"><strong>Pickup:</strong> @trip.PickupPoint</div>
                                <div class="col-md-6"><strong>Drop:</strong> @trip.DropPoint</div>
                            </div>
                            <div class="mt-3 d-flex align-items-center justify-content-between trackRow" style="position: relative; height: 60px;">
                                <button class="btn btn-success startBtn" data-vehicle="@trip.VehicleType">Start</button>
                                <div class="trackArea" style="flex-grow: 1; position: relative; height: 40px; margin: 0 20px;">
                                    <i class="fa-solid fa-truck truckIcon" style="position: absolute; top: 8px; left: 0; font-size: 24px; color: #131313;"></i>
                                </div>
                                <button class="btn btn-danger stopBtn" data-vehicle="@trip.VehicleType">End</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade mt-5" id="fareModal" tabindex="-1" aria-labelledby="fareModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content shadow">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title" id="fareModalLabel">Fare Calculation</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form method="post" asp-controller="Driver" asp-action="CompleteTrip">
                                        <input type="hidden" name="tripId" value="@trip.TripId" />
                                        <div class="mb-3">
                                            <label for="kilometers" class="form-label">Kilometers</label>
                                            <input type="number" class="form-control" id="kilometers" required />
                                        </div>
                                        <div class="mb-3">
                                            <label for="costPerKm" class="form-label">Cost per Km</label>
                                            <input type="number" class="form-control" id="costPerKm" readonly />
                                        </div>
                                        <div class="mb-3">
                                            <label for="totalFare" class="form-label">Total Fare</label>
                                            <input type="text" class="form-control" id="totalFare" readonly />
                                        </div>
                                        <button type="button" class="btn btn-primary w-100" id="calculateFareBtn">Calculate</button>
                                        <div id="paymentSection" class="mt-4" style="display: none;">
                                            <h6>Choose Payment Method</h6>
                                            <div class="mb-3">
                                                <select class="form-select" id="paymentMethod">
                                                    <option value="" disabled selected>Select a method</option>
                                                    <option value="credit">Credit Card</option>
                                                    <option value="debit">Debit Card</option>
                                                    <option value="upi">UPI</option>
                                                    <option value="cash">Cash</option>
                                                </select>
                                            </div>
                                            <button type="submit" class="btn btn-success w-100" id="confirmPaymentBtn" asp-controller="Driver" asp-action="CompleteTrip" >Confirm Payment</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="alert alert-info text-center">No trips assigned yet.</div>
            }
        </div>
    </div>

    <!-- Fare Calculation Modal -->
    @* <div class="modal fade mt-5" id="fareModal" tabindex="-1" aria-labelledby="fareModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="fareModalLabel">Fare Calculation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-controller="Driver" asp-action="CompleteTrip">
                        <input type="hidden" name="tripId" value="@trip.TripId" />
                        <div class="mb-3">
                            <label for="kilometers" class="form-label">Kilometers</label>
                            <input type="number" class="form-control" id="kilometers" required />
                        </div>
                        <div class="mb-3">
                            <label for="costPerKm" class="form-label">Cost per Km</label>
                            <input type="number" class="form-control" id="costPerKm" readonly />
                        </div>
                        <div class="mb-3">
                            <label for="totalFare" class="form-label">Total Fare</label>
                            <input type="text" class="form-control" id="totalFare" readonly />
                        </div>
                        <button type="button" class="btn btn-primary w-100" id="calculateFareBtn">Calculate</button>
                        <div id="paymentSection" class="mt-4" style="display: none;">
                            <h6>Choose Payment Method</h6>
                            <div class="mb-3">
                                <select class="form-select" id="paymentMethod">
                                    <option value="" disabled selected>Select a method</option>
                                    <option value="credit">Credit Card</option>
                                    <option value="debit">Debit Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="cash">Cash</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-success w-100" id="confirmPaymentBtn">Confirm Payment</button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div> *@
    

</div>

@section Scripts {
<script>
    $(document).ready(function () {
        let costPerKm = 0;
       
        $(".startBtn").click(function () {
            const vehicleType = $(this).data("vehicle")?.toString().trim().toLowerCase();

            if (vehicleType === "4wheeler") {
                costPerKm = 15;
            } else if (vehicleType === "6wheeler") {
                costPerKm = 30;
            } else if (vehicleType === "10wheeler") {
                costPerKm = 50;
            }

            $("#costPerKm").val(costPerKm).prop("readonly", true);

            const track = $(this).closest(".trackRow");
            const truck = track.find(".truckIcon");
            const stopBtn = track.find(".stopBtn");

            const startLeft = $(this).outerWidth(true);
            const endLeft = track.width() - stopBtn.outerWidth(true) - truck.outerWidth(true) - 90;

            truck.css("left", startLeft).stop().animate({ left: endLeft }, 10000);
        });

        $(".stopBtn").click(function () {
            const track = $(this).closest(".trackRow");
            const truck = track.find(".truckIcon");
            const stopBtn = $(this);

            const endLeft = track.width() - stopBtn.outerWidth(true) - truck.outerWidth(true) - 90;
            truck.stop().css("left", endLeft);

            new bootstrap.Modal(document.getElementById("fareModal")).show();
        });

        $("#calculateFareBtn").click(function () {
            const km = parseFloat($("#kilometers").val());
            const cost = parseFloat($("#costPerKm").val());
            if (!isNaN(km) && !isNaN(cost)) {
                $("#totalFare").val(`₹${(km * cost).toFixed(2)}`);
                    $("#paymentSection").slideDown();

            } else {
                alert("Please enter valid numbers.");
            }

        });
    });
        
        setTimeout(() => {
            const alert = document.querySelector('.alert1');
            if (alert) {
                alert.classList.remove('show'); // fade out
                setTimeout(() => {
                    alert.remove(); // remove from DOM after fade
                }, 500); // wait for fade-out animation to finish
            }
        }, 4000);
   
</script>
}
